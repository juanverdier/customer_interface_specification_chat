from utils.env_setup import client
from utils.helpers import generate_trace_id_code

def improve_query(user_query):
    """Enhances the user query by identifying relevant Data Elements before retrieval."""
    trace_id = generate_trace_id_code()  # Generate trace ID

    system_message = {
        "role": "system",
        "content": [
            {
                "text": "'Tu funcion es mejorar la consulta del usuario.\\n\\nDebajo esta la lista de los 128 Data Elements, tienes que identificar si el usuario esta preguntando por alguno de esos.\\n\\nEn ese caso, deberias ampliar la consulta del usuario agregando el nombre deel o los data elements que el esté buscando pero sin eliminar nada del resto de la consulta del humano. En tu respuesta debe figurar tanto el número como el nombre del Data Element (DE). Limitate unicamente a responder la consulta mejorada, no des contexto ni explicaciones.\\n\\n| Number | Name | Data Representation |\\n|--------|------|---------------------|\\n| 1 | Bit Map, Secondary | b-8 |\\n| 2 | Primary Account Number (PAN) | n...19; LLVAR |\\n| 3 | Processing Code | n-6 |\\n| 4 | Amount, Transaction | n-12 |\\n| 5 | Amount, Settlement | n-12 |\\n| 6 | Amount, Cardholder Billing | n-12 |\\n| 7 | Transmission Date and Time | n-10 |\\n| 8 | Amount, Cardholder Billing Fee⁷ | n-8 |\\n| 9 | Conversion Rate, Settlement | n-8 |\\n| 10 | Conversion Rate, Cardholder Billing | n-8 |\\n| 11 | Systems Trace Audit Number | n-6 |\\n| 12 | Time, Local Transaction | n-6 |\\n| 13 | Date, Local Transaction | n-4 |\\n| 14 | Date, Expiration | n-4 |\\n| 15 | Date, Settlement | n-4 |\\n| 16 | Date, Conversion | n-4 |\\n| 17 | Date, Capture⁷ | n-4 |\\n| 18 | Merchant Type | n-4 |\\n| 19 | Acquiring Institution Country Code⁷ | n-3 |\\n| 20 | Primary Account Number (PAN) Country Code | n-3 |\\n| 21 | Forwarding Institution Country Code⁷ | n-3 |\\n| 22 | Point-of-Service (POS) Entry Mode | n-3 |\\n| 23 | Card Sequence Number | n-3 |\\n| 24 | Network International ID⁷ | n-3 |\\n| 25 | Point-of-Service (POS) Condition Code⁷ | n-2 |\\n| 26 | Point-of-Service (POS) Personal ID Number (PIN) Capture Code | n-2 |\\n| 27 | Authorization ID Response Length⁷ | n-1 |\\n| 28 | Amount, Transaction Fee | an-9 |\\n| 29 | Amount, Settlement Fee⁷ | an-9 |\\n| 30 | Amount, Transaction Processing Fee⁷ | an-9 |\\n| 31 | Amount, Settlement Processing Fee⁷ | an-9 |\\n| 32 | Acquiring Institution ID Code | n...6; LLVAR |\\n| 33 | Forwarding Institution ID Code | n...6; LLVAR |\\n| 34 | Primary Account Number (PAN), Extended⁷ | ans...28; LLVAR |\\n| 35 | Track 2 Data | ans...37; LLVAR |\\n| 36 | Track 3 Data⁷ | ans...104; LLLVAR |\\n| 37 | Retrieval Reference Number | an-12 |\\n| 38 | Authorization ID Response | ans-6 |\\n| 39 | Response Code | an-2 |\\n| 40 | Service Restriction Code⁷ | an-3 |\\n| 41 | Card Acceptor Terminal ID | ans-8 |\\n| 42 | Card Acceptor ID Code | ans-15 |\\n| 43 | Card Acceptor Name/Location | ans-40 |\\n| 44 | Additional Response Data | ans...25; LLVAR |\\n| 45 | Track 1 Data | ans...76; LLVAR |\\n| 46 | Additional Data—ISO Use⁷ | ans...999; LLLVAR |\\n| 47 | Additional Data—National Use⁸ | ans...999; LLLVAR |\\n| 48 | Additional Data—Private Use | ans...999; LLLVAR |\\n| 49 | Currency Code, Transaction | n-3 |\\n| 50 | Currency Code, Settlement | n-3 |\\n| 51 | Currency Code, Cardholder Billing | n-3 |\\n| 52 | Personal ID Number (PIN) Data | b-8 |\\n| 53 | Security-Related Control Information | n-16 |\\n| 54 | Additional Amounts | an...240; LLLVAR |\\n| 55 | Integrated Circuit Card (ICC) System-Related Data | b...255; LLLVAR |\\n| 56 | Payment Account Data | an...37; LLVAR |\\n| 57-59 | Reserved for National Use<sup>8</sup> | ans...999; LLLVAR |\\n| 60 | Advice Reason Code<sup>10</sup> | ans...060; LLLVAR |\\n| 61 | Point-of-Service (POS) Data<sup>10</sup> | an...026; LLLVAR |\\n| 62 | Intermediate Network Facility (INF) Data<sup>10</sup> | ans...100; LLLVAR |\\n| 63 | Network Data<sup>10</sup> | an...050; LLLVAR |\\n| 64 | Message Authentication Code (MAC)<sup>7</sup> | b-8 |\\n| 65 | Bit Map, Extended<sup>7</sup> | b-8 |\\n| 66 | Settlement Code<sup>7</sup> | n-1 |\\n| 67 | Extended Payment Code<sup>7</sup> | n-2 |\\n| 68 | Receiving Institution Country Code<sup>7</sup> | n-3 |\\n| 69 | Settlement Institution Country Code<sup>7</sup> | n-3 |\\n| 70 | Network Management Information Code | n-3 |\\n| 71 | Message Number<sup>7</sup> | n-4 |\\n| 72 | Message Number Last<sup>7</sup> | n-4 |\\n| 73 | Date, Action | n-6 |\\n| 74 | Credits, Number<sup>7</sup> | n-10 |\\n| 75 | Credits, Reversal Number<sup>7</sup> | n-10 |\\n| 76 | Debits, Number<sup>7</sup> | n-10 |\\n| 77 | Debits, Reversal Number<sup>7</sup> | n-10 |\\n| 78 | Transfers, Number<sup>7</sup> | n-10 |\\n| 79 | Transfers, Reversal Number<sup>7</sup> | n-10 |\\n| 80 | Inquiries, Number<sup>7</sup> | n-10 |\\n| 81 | Authorizations, Number<sup>7</sup> | n-10 |\\n| 82 | Credits, Processing Fee Amount<sup>7</sup> | n-12 |\\n| 83 | Credits, Transaction Fee Amount<sup>7</sup> | n-12 |\\n| 84 | Debits, Processing Fee Amount<sup>7</sup> | n-12 |\\n| 85 | Debits, Transaction Fee Amount<sup>7</sup> | n-12 |\\n| 86 | Credits, Amount<sup>7</sup> | n-16 |\\n| 87 | Credits, Reversal Amount⁷ | n-16 |\\n| 88 | Debits, Amount⁷ | n-16 |\\n| 89 | Debits, Reversal Amount⁷ | n-16 |\\n| 90 | Original Data Elements | n-42 |\\n| 91 | Issuer File Update Code | an-1 |\\n| 92 | File Security Code⁷ | an-2 |\\n| 93 | Response Indicator⁷ | an-5 |\\n| 94 | Service Indicator | an-7 |\\n| 95 | Replacement Amounts | n-42 |\\n| 96 | Message Security Code¹⁰ | b-8 |\\n| 97 | Amount, Net Settlement⁷ | an-17 |\\n| 98 | Payee | ans-25 |\\n| 99 | Settlement Institution ID Code⁷ | n...11; LLVAR |\\n| 100 | Receiving Institution ID Code | n...11; LLVAR |\\n| 101 | File Name | ans...17; LLVAR |\\n| 102 | Account ID-1 | ans...28; LLVAR |\\n| 103 | Account ID-2 | ans...28; LLVAR |\\n| 104 | Digital Payment Data⁷ | ans...999; LLLVAR |\\n| 105–107 | Reserved for Mastercard Use⁷ | ans...999; LLLVAR |\\n| 108 | Additional Transaction Reference Data | ans...999; LLLVAR |\\n| 109 | Reserved for ISO Use⁷ | ans...999; LLLVAR |\\n| 110 | Additional Data—2 | ans...999; LLLVAR |\\n| 111 | Reserved for ISO Use⁷ | ans...999; LLLVAR |\\n| 112 | Additional Data (National Use) | ans...100; LLLVAR |\\n| 113–119 | Reserved for National Use⁸ | ans...999; LLLVAR |\\n| 120 | Record Data¹⁰ | ans...999; LLLVAR |\\n| 121 | Authorizing Agent ID Code¹⁰ | n...6; LLLVAR |\\n| 122 | Additional Record Data¹⁰ | ans...999; LLLVAR |\\n| 123 | Receipt Free Text | ans...512; LLLVAR |\\n| 124 | Member-defined Data | ans...199; LLLVAR |\\n| 125 | New PIN Data | b-8 |\\n| 126 | Private Data | ans...100; LLLVAR |\\n| 127 | Private Data<sup>10</sup> | ans...100; LLLVAR |\\n| 128 | Message Authentication Code (MAC)<sup>7</sup> | b-8 |\\n\\n'",
                "type": "text"
            }
        ]
    }

    user_message = {
        "role": "user",
        "content": user_query
    }

    response = client.chat.completions.create(
        model="gpt-4o-mini",  # Using GPT-4o-mini for query improvement
        messages=[system_message, user_message],
        response_format={"type": "text"},
        temperature=0.3,
        max_completion_tokens=256,
        top_p=1,
        frequency_penalty=0,
        presence_penalty=0
    )

    improved_query = response.choices[0].message.content.strip()
    return improved_query